name: "build miniupnpc wheels"

on:
  push:
    branches:
      - master
      - test

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: 3.11
      - name: Build (Windows)
        working-directory: miniupnpc
        run: |        
          mingw32-make -f Makefile.mingw CC=gcc
          python -m pip install wheel
          mingw32-make -f Makefile.mingw pythonmodule PYTHON=python
          ls dist
          7z a dist/*.whl miniupnpc.dll
          mkdir ../dist
          cp dist/*.whl ../dist

      - name: Install
        if: matrix.arch.matrix != 'arm'
        run: |
          pip install --no-index --only-binary :all: --find-links dist miniupnpc

      - name: Import
        if: matrix.arch.matrix != 'arm'
        run: |
          python -c 'import miniupnpc; print(miniupnpc)'

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: wheel
          path: ./dist
          if-no-files-found: error
